name: Main

on:
  pull_request:

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  main:
    runs-on: ubuntu-latest
    steps:
    - name: â¬ Checkout
      uses: actions/checkout@v4
      with:
        ref: ${{ github.head_ref }}

    - name: ğŸ’¾ Cache
      uses: actions/cache@v4.2.0
      with:
        path: target/
        key: target

    - name: ğŸ¦€ Rust setup
      run: |
        rustup default stable
        rustup update

    - name: ğŸ› ï¸ Install Blender and dependencies
      run: sudo apt-get install -y blender libudev-dev

    - name: ğŸ“ Clippy
      run: cargo clippy --fix

    - name: ğŸ§¹ RustFmt
      run: cargo fmt --verbose --all

    - name: ğŸ‘€ Checking for changes ...
      id: changes
      run: |
        STATUS="$(git status --porcelain)"
        echo "status=$STATUS" >> "$GITHUB_OUTPUT"

    - name: â« Push changes
      if: ${{ steps.changes.outputs.status != '' }}
      run: |
        echo "Changes detected. Committing and pushing..."
        
        # Print status to visually see what changed
        git status
      
        git config --global user.name 'github-actions[bot]'
        git config --global user.email '41898282+github-actions[bot]@users.noreply.github.com'
      
        git add --all
        git commit -m "Automated clippy run by CI"
        git push
      
        echo "Git push completed."
        echo "Subsequent tasks should be skipped until above tasks return a clean state!"

    - name: ğŸ” Check
      if: ${{ steps.changes.outputs.status == '' }}
      run: cargo check

    - name: ğŸ§ª Test
      if: ${{ steps.changes.outputs.status == '' }}
      run: cargo test
