name: Clippy

on:
  pull_request:

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: ⏬ Checkout
      uses: actions/checkout@v4
      with:
        ref: ${{ github.head_ref }}

    - name: 💾 Cache
      uses: actions/cache@v4.2.0
      with:
        path: target/
        key: target

    - name: 🦀 Rust setup
      run: |
        rustup default stable
        rustup update

    - name: 🛠️ Install LibUDev
      run: sudo apt-get install -y libudev-dev

    - name: 📎 Clippy
      run: cargo clippy --fix
      
    - name: ⏫ Commit changes
      run: |
        if [[ -z "$(git status --porcelain)" ]]; then
          echo "No changes to commit, working tree clean. Skipping commit and push."
        else
          echo "Changes detected. Committing and pushing..."
        
          # Print status to visually see what changed
          git status
        
          git config --global user.name 'github-actions[bot]'
          git config --global user.email '41898282+github-actions[bot]@users.noreply.github.com'
        
          git add --all
          git commit -m "Automated clippy run by CI"
          git push
        
          echo "Git push completed."
        fi
